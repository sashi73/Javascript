<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zodiac Personality Analyzer</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .result-card {
            background: #f9f9f9;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        .zodiac-animal {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2em;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        #apiKeyContainer {
            margin: 20px 0;
            padding: 15px;
            background: #eaf7fd;
            border-radius: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Zodiac Personality Analyzer</h1>
        
        <div id="apiKeyContainer">
            <label for="apiKeyInput">Enter your OpenAI API key:</label>
            <input type="password" id="apiKeyInput" placeholder="sk-xxxxxxxxxxxxxxxx">
            <small>Your key is used locally and not stored anywhere.</small>
        </div>
        
        <button id="calculateBtn">Analyze My Zodiac Personality</button>
        
        <div id="resultContainer" class="result-card" style="display: none;">
            <h2>Your Results</h2>
            <p id="ageResult"></p>
            <p id="yearResult"></p>
            <p>Your Chinese zodiac animal is: <span id="zodiacResult" class="zodiac-animal"></span></p>
            <div id="aiInsights"></div>
        </div>
    </div>

    <script>
        // Constants
        const ZODIAC_ANIMALS = [
            "Rat", "Ox", "Tiger", "Rabbit", "Dragon", 
            "Snake", "Horse", "Goat", "Monkey", "Rooster", "Dog", "Pig"
        ];
        const CURRENT_YEAR = new Date().getFullYear();
        const OPENAI_MODEL = "gpt-3.5-turbo";

        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const resultContainer = document.getElementById('resultContainer');
        const ageResult = document.getElementById('ageResult');
        const yearResult = document.getElementById('yearResult');
        const zodiacResult = document.getElementById('zodiacResult');
        const aiInsights = document.getElementById('aiInsights');

        // Main function
        async function calculateZodiac() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showError("Please enter your OpenAI API key");
                return;
            }

            try {
                const birthYear = await getValidBirthYear(); // Added await
                if (!birthYear) return; // Handle case where user cancels prompt
                
                const age = calculateAge(birthYear);
                const zodiacAnimal = getChineseZodiac(birthYear);
                
                displayResults(age, birthYear, zodiacAnimal);
                await fetchZodiacInsights(zodiacAnimal, apiKey);
            } catch (error) {
                showError(error.message);
                console.error("Error:", error); // Added error logging
            }
        }

        // Helper functions
        function getValidBirthYear() {
            return new Promise((resolve) => {
                const input = prompt("Enter your birth year (YYYY):");
                if (!input) {
                    resolve(null);
                    return;
                }
                
                const birthYear = parseInt(input);
                if (isNaN(birthYear)) {
                    throw new Error('Please enter a valid year');
                }
                if (birthYear < 1400 || birthYear > CURRENT_YEAR) {
                    throw new Error(`Please enter a year between 1400 and ${CURRENT_YEAR}`);
                }
                
                resolve(birthYear);
            });
        }

        function calculateAge(birthYear) {
            return CURRENT_YEAR - birthYear;
        }

        function getChineseZodiac(birthYear) {
            const zodiacIndex = (birthYear - 4) % 12;
            return ZODIAC_ANIMALS[zodiacIndex >= 0 ? zodiacIndex : zodiacIndex + 12];
        }

        function displayResults(age, birthYear, zodiacAnimal) {
            ageResult.textContent = `You are ${age} years old`;
            yearResult.textContent = `You were born in ${birthYear}`;
            zodiacResult.textContent = zodiacAnimal;
            resultContainer.style.display = 'block';
        }

        async function fetchZodiacInsights(zodiacAnimal, apiKey) {
            aiInsights.innerHTML = '<p class="loading">Generating personality insights with OpenAI Model 3.5...</p>';
            
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [
                            {
                                role: "system",
                                content: "You are a knowledgeable Chinese zodiac expert with unique trait in your field. Provide concise, accurate personality analysis with clarity and I want you to be dilligent and outsanding that it will amaze me."
                            },
                            {
                                role: "user",
                                content: `Give me 3 paragraphs formatted professional personality analysis for someone with the Chinese zodiac ${zodiacAnimal}. 
                                          Focus on key traits, strengths, weaknesses, and compatibility and suprise me. Use markdown formatting. Be as detailed as possible. Once you are done, create two other paragraphs providing an outlook for this Year, write the header in bold stating "Outlook for this year", search the web for more accurate results and refer to expert websites about ${zodiacAnimal}`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 4000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API request failed");
                }

                const data = await response.json();
                const analysis = data.choices[0]?.message?.content || "No analysis available";
                aiInsights.innerHTML = `<h2>${zodiacAnimal} Personality Traits & Outlook for the Year</h2><div>${marked.parse(analysis)}</div>`;
            } catch (error) {
                console.error("API Error:", error);
                aiInsights.innerHTML = `<p class="error">Error: ${error.message}. Please check your API key and try again.</p>`;
            }
        }

        function showError(message) {
            resultContainer.style.display = 'block';
            aiInsights.innerHTML = `<p class="error">${message}</p>`;
        }

        // Event listener
        calculateBtn.addEventListener('click', () => {
            calculateZodiac().catch(error => {
                console.error("Unhandled error:", error);
                showError("An unexpected error occurred");
            });
        });
    </script>
    <!-- Add Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>